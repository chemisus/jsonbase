/*! jsonbase 12-02-2014 */
function Constraint(){this.preTableInsert=function(){},this.postTableInsert=function(){},this.preTableUpdate=function(){},this.postTableUpdate=function(){},this.preTableDelete=function(){},this.postTableDelete=function(){},this.preDatabaseInsert=function(){},this.postDatabaseInsert=function(){},this.preDatabaseUpdate=function(){},this.postDatabaseUpdate=function(){},this.preDatabaseDelete=function(){},this.postDatabaseDelete=function(){}}function Database(){this.initFile=function(a){return{name:a,migration:0,constraints:{},constraint_keys:[],tables:{}}},this.saveFile=function(a){localStorage.setItem(a.name,angular.toJson(a))},this.loadFile=function(a){return localStorage.getItem(a)?angular.fromJson(localStorage.getItem(a)):null},this.dropDatabase=function(a){localStorage.removeItem(a)},this.hasTable=function(a,b){return a.tables.hasOwnProperty(b)},this.migrateDatabase=function(a,b,c){for(;a.migration<c.length;a.migration++)c[a.migration].up(a,b);this.saveFile(a)},this.addConstraint=function(a,b){a.constraints[b.name]=b,a.constraint_keys.push(b.name)},this.query=function(a,b,c,d){var e=new Query(d);return new QueryBuilder(a,b,e,e.make(c),d)}}function GenerateConstraint(a){angular.extend(this,new Constraint),this.create=function(b,c,d,e){(new Database).addConstraint(b,{name:c,type:a,table_name:d,field_name:e,current:1,step:1})},this.preTableInsert=function(a,b,c,d){c===b.table_name&&(d.hasOwnProperty(b.field_name)||(d[b.field_name]=b.current,b.current+=b.step))}}function Jsonbase(a,b,c,d,e){b=b||new Database,c=c||new Table,d=d||new Migration,a=a||b.initFile("db"),this.insert=function(b,d){c.insert(a,e,b,d)}}function Migration(){this.create=function(a,b){return{up:a||function(){},down:b||function(){}}}}function AndOperation(){this.make=function(a){return{op:"and",value:a}},this.execute=function(a,b){for(var c in b.value)if(!operations[b.value[c].op].execute(a,b.value[c]))return!1;return!0}}function ConstOperation(){this.make=function(a){return{op:"const",value:a}},this.execute=function(a,b){return b.value}}function EqualOperation(){this.make=function(a,b){return{op:"eq",lhs:a,rhs:b}},this.execute=function(a,b,c){return c[b.lhs.op].execute(a,b.lhs,c)===c[b.rhs.op].execute(a,b.rhs,c)}}function GreaterThanOperation(){this.make=function(a,b){return{op:"gt",lhs:a,rhs:b}},this.execute=function(a,b,c){return c[b.lhs.op].execute(a,b.lhs,c)>c[b.rhs.op].execute(a,b.rhs,c)}}function GreaterThanOrEqualOperation(){this.make=function(a,b){return{op:"gte",lhs:a,rhs:b}},this.execute=function(a,b,c){return c[b.lhs.op].execute(a,b.lhs,c)>=c[b.rhs.op].execute(a,b.rhs,c)}}function LessThanOperation(){this.make=function(a,b){return{op:"lt",lhs:a,rhs:b}},this.execute=function(a,b,c){return c[b.lhs.op].execute(a,b.lhs,c)<c[b.rhs.op].execute(a,b.rhs,c)}}function LessThanOrEqualOperation(){this.make=function(a,b){return{op:"lte",lhs:a,rhs:b}},this.execute=function(a,b,c){return c[b.lhs.op].execute(a,b.lhs,c)<=c[b.rhs.op].execute(a,b.rhs,c)}}function NotOperation(){this.make=function(a){return{op:"not",value:a}},this.execute=function(a,b,c){return!c[b.value.op].execute(a,b.value,c)}}function OrOperation(){this.make=function(a){return{op:"or",value:a}},this.execute=function(a,b,c){for(var d in b.value)if(c[b.value[d].op].execute(a,b.value[d],c))return!0;return!1}}function SelectOperation(){this.make=function(a,b){return{type:"select",records:a,value:b}},this.execute=function(a,b,c){return b.records.filter(function(a){return c[b.value.op].execute(a,b.value,c)})}}function ValueOperation(){this.make=function(a){return{op:"value",value:a}},this.execute=function(a,b){return a[b.value]}}function Query(){this.make=function(a){return{from:a}},this.execute=function(a,b){return b[a.type].execute(null,a,b)}}function QueryBuilder(a){this.const=function(b){return a.const.make(b)},this.value=function(b){return a.value.make(b)},this.eq=function(b,c){return a.eq.make(b,c)},this.gt=function(b,c){return a.gt.make(b,c)},this.gte=function(b,c){return a.gte.make(b,c)},this.lt=function(b,c){return a.lt.make(b,c)},this.lte=function(b,c){return a.lte.make(b,c)},this.or=function(b){return a.or.make(b)},this.and=function(b){return a.and.make(b)},this.not=function(b){return a.not.make(b)},this.select=function(b,c){return a.select.make(b,c)}}function SaveDatabaseConstraint(a){angular.extend(this,new Constraint),this.create=function(b,c){(new Database).addConstraint(b,{name:c,type:a})},this.postDatabaseInsert=function(a){(new Database).saveFile(a)},this.postDatabaseUpdate=function(a){(new Database).saveFile(a)},this.postDatabaseDelete=function(a){(new Database).saveFile(a)}}function Table(){this.create=function(a,b){a.tables[b]={name:b,records:[]}},this.getConstraintData=function(a,b){var c=a.constraint_keys[b];return a.constraints[c]},this.getConstraint=function(a,b,c){var d=b.type;return c[d]},this.callConstraint=function(a,b,c,d,e){for(var f in b.constraint_keys){var g=this.getConstraintData(b,f),h=this.getConstraint(b,g,c);h[a](b,g,d,e)}},this.select=function(a,b,c,d){d={from:"table1",where:{op:"or",value:[{op:"eq",field:"id",value:{op:"const",value:9}},{op:"eq",field:"id",value:{op:"const",value:5}}]}}},this.insert=function(a,b,c,d){var e=a.tables[c];this.callConstraint("preDatabaseInsert",a,b,c,d),this.callConstraint("preTableInsert",a,b,c,d),e.records.push(d),this.callConstraint("postTableInsert",a,b,c,d),this.callConstraint("postDatabaseInsert",a,b,c,d)},this.delete=function(a,b,c,d){var e=a.tables[c];this.callConstraint("preDatabaseDelete",a,b,c,d),this.callConstraint("preTableDelete",a,b,c,d);var f=e.records.indexOf(d);-1!==f&&e.records.splice(f,1),this.callConstraint("postTableDelete",a,b,c,d),this.callConstraint("postDatabaseDelete",a,b,c,d)}}function UniqueConstraint(a){angular.extend(this,new Constraint),this.create=function(b,c,d,e){(new Database).addConstraint(b,{name:c,type:a,table_name:d,field_name:e})},this.preTableInsert=function(a,b,c,d){if(c===b.table_name){var e=a.tables[c].records.filter(function(a){return a[b.field_name]==d[b.field_name]});if(e.length>0)throw"fails unique constraint"}}}