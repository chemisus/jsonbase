/*! jsonbase 13-02-2014 */
function Database(){}function Environment(){this.execute=function(a){return this.operations[a[0]].execute(a,this)},this.pushRecord=function(a){this.records.push(this.record),this.record=a},this.popRecord=function(){this.record=this.records.pop()},this.pushLeft=function(a){this.lefts.push(this.left),this.left=a},this.popLeft=function(){this.left=this.lefts.pop()},this.pushRight=function(a){this.rights.push(this.right),this.right=a},this.popRight=function(){this.right=this.rights.pop()}}function EnvironmentFactory(a,b){a=a||JSON.stringify,b=b||JSON.parse,this.toJson=function(){return a},this.fromJson=function(){return b},this.make=function(c,d){c=c||{constraints:{keys:[],values:{}},tables:{keys:[],values:{}}},d=d||{};var e=new Environment;return e.file=c,e.operations=d.operations||this.makeOperations(),e.constraints=d.constraints||this.makeConstraints(),e.database=d.database||this.makeDatabase(),e.table=d.table||this.makeTable(),e.toJson=a,e.fromJson=b,e.query_builder=this.makeQueryBuilder(e),e.record=null,e.left=null,e.right=null,e.records=[],e.lefts=[],e.rights=[],e},this.makeOperations=function(){return{select:new SelectOperation,table:new TableOperation,"const":new ConstOperation,get:new GetOperation,eq:new EqualOperation,or:new OrOperation,and:new AndOperation,not:new NotOperation,"true":new TrueOperation,"in":new InOperation,path:new PathOperation,like:new LikeOperation,left:new LeftOperation,right:new RightOperation,join:new JoinOperation,param:new ParameterOperation}},this.makeConstraints=function(){},this.makeDatabase=function(){return new Database},this.makeTable=function(){return new Table},this.makeQueryBuilder=function(a){return new QueryBuilder(a)}}function Jsonbase(a){this.save=function(){localStorage.setItem(a.name,a.toJson(a.file))},this.reload=function(){a.file=a.fromJson(localStorage.getItem(a.name)||"null")},this.environment=function(){return a},this.file=function(){return a.file},this.queryBuilder=function(){return a.query_builder},this.createTable=function(b){a.table.createTable(this.file(),b)},this.insert=function(b,c){a.table.insert(this.file(),b,c)},this.matches=function(b,c,d){d=d||{};var e=this.queryBuilder(),f=[];for(var g in c){var h=a.operations[d[g]]||e.eq;f.push(h(e.get(g),e.const(c[g])))}return e.execute(e.select(e.table(b),e.and(f)))}}function AndOperation(){this.make=function(a){return["and",a]},this.execute=function(a,b){for(var c=0;c<a[1].length;c++)if(!b.execute(a[1][c]))return!1;return!0}}function ConstOperation(){this.make=function(a){return["const",a]},this.execute=function(a){return a[1]}}function EqualOperation(){this.make=function(a,b){return["eq",a,b]},this.execute=function(a,b){var c=b.execute(a[1]),d=b.execute(a[2]);return c==d}}function GetOperation(){this.make=function(a){return["get",a]},this.execute=function(a,b){return b.record[a[1]]}}function InOperation(){this.make=function(a,b){return["in",a,b]},this.execute=function(a,b){for(var c=b.execute(a[1]),d=b.execute(a[2]),e=0;e<d.length;e++)if(c===d[e])return!0;return!1}}function JoinOperation(){this.make=function(a,b,c,d){return["join",a,b,c,d]},this.clone=function(a){var b={};for(var c in a)b[c]=a[c];return b},this.execute=function(a,b){for(var c=b.execute(a[1]),d=b.execute(a[2]),e=[],f=0;f<c.length;f++){var g=this.clone(c[f]);g[a[4]]=[],b.pushLeft(g);for(var h=0;h<d.length;h++){var i=this.clone(d[h]);b.pushRight(i),b.execute(a[3])&&g[a[4]].push(i),b.popRight()}b.popLeft(),e.push(g)}return e}}function LeftOperation(){this.make=function(a){return["left",a]},this.execute=function(a,b){b.pushRecord(b.left);var c=b.execute(a[1]);return b.popRecord(),c}}function LikeOperation(){this.make=function(a,b){return["like",a,b]},this.execute=function(a,b){var c=b.execute(a[1]),d=b.execute(a[2]);return d=d.replace(/%/g,".*?"),new RegExp(d).test(c)}}function NotOperation(){this.make=function(a){return["not",a]},this.execute=function(a,b){return!b.execute(a[1])}}function OrOperation(){this.make=function(a){return["or",a]},this.execute=function(a,b){for(var c=0;c<a[1].length;c++)if(b.execute(a[1][c]))return!0;return!1}}function ParameterOperation(){this.make=function(a){return["param",a]},this.execute=function(a,b){return b.parameters[a[1]]}}function PathOperation(){this.make=function(a){return["path",a]},this.execute=function(a,b){for(var c=a[1].split("."),d=b.record,e=0;e<c.length;e++)d=d[c[e]];return d}}function RightOperation(){this.make=function(a){return["right",a]},this.execute=function(a,b){b.pushRecord(b.right);var c=b.execute(a[1]);return b.popRecord(),c}}function SelectOperation(){this.make=function(a,b){return["select",a,b]},this.execute=function(a,b){var c=b.execute(a[1]).filter(function(c){return b.record=c,b.execute(a[2])});return b.record=null,c}}function TableOperation(){this.make=function(a){return["table",a]},this.execute=function(a,b){return b.file.tables.values[a[1]]}}function TrueOperation(){this.make=function(){return["true"]},this.execute=function(){return!0}}function QueryBuilder(a){this.select=function(b,c){return a.operations.select.make(b,c)},this.table=function(b){return a.operations.table.make(b)},this.get=function(b){return a.operations.get.make(b)},this.path=function(b){return a.operations.path.make(b)},this.const=function(b){return a.operations.const.make(b)},this.not=function(b){return a.operations.not.make(b)},this.eq=function(b,c){return a.operations.eq.make(b,c)},this.true=function(){return a.operations.true.make()},this.param=function(b){return a.operations.param.make(b)},this.and=function(b){return a.operations.and.make(b)},this.or=function(b){return a.operations.or.make(b)},this.in=function(b,c){return a.operations.in.make(b,c)},this.like=function(b,c){return a.operations.like.make(b,c)},this.join=function(b,c,d,e){return a.operations.join.make(b,c,d,e)},this.left=function(b){return a.operations.left.make(b)},this.right=function(b){return a.operations.right.make(b)},this.execute=function(b){return a.operations[b[0]].execute(b,a)}}function Table(){this.createTable=function(a,b){a.tables.keys.push(b),a.tables.values[b]=[]},this.insert=function(a,b,c){a.tables.values[b].push(c)}}Jsonbase.Load=function(a){var b=new EnvironmentFactory,c=b.fromJson()(localStorage.getItem(a)||"null"),d=b.make(c);return new Jsonbase(d)};