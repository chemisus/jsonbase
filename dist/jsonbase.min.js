/*! jsonbase 13-02-2014 */
function Database(){}function EnvironmentFactory(a,b){a=a||JSON.stringify,b=b||JSON.parse,this.toJson=function(){return a},this.fromJson=function(){return b},this.make=function(c,d){c=c||{constraints:{keys:[],values:{}},tables:{keys:[],values:{}}},d=d||{};var e={file:c,operations:d.operations||this.makeOperations(),constraints:d.constraints||this.makeConstraints(),database:d.database||this.makeDatabase(),table:d.table||this.makeTable(),toJson:a,fromJson:b};return e.query_builder=this.makeQueryBuilder(e),e},this.makeOperations=function(){return{select:new SelectOperation,table:new TableOperation,"const":new ConstOperation,get:new GetOperation,eq:new EqualOperation,or:new OrOperation,and:new AndOperation,not:new NotOperation,"true":new TrueOperation,"in":new InOperation,path:new PathOperation}},this.makeConstraints=function(){},this.makeDatabase=function(){return new Database},this.makeTable=function(){return new Table},this.makeQueryBuilder=function(a){return new QueryBuilder(a)}}function Jsonbase(a){this.save=function(){localStorage.setItem(a.name,a.toJson(a.file))},this.reload=function(){a.file=a.fromJson(localStorage.getItem(a.name)||"null")},this.environment=function(){return a},this.file=function(){return a.file},this.queryBuilder=function(){return a.query_builder},this.createTable=function(b){a.table.createTable(this.file(),b)},this.insert=function(b,c){a.table.insert(this.file(),b,c)}}function AndOperation(){this.make=function(a){return["and",a]},this.execute=function(a,b){for(var c=0;c<a[1].length;c++)if(!b.operations[a[1][c][0]].execute(a[1][c],b))return!1;return!0}}function ConstOperation(){this.make=function(a){return["const",a]},this.execute=function(a){return a[1]}}function EqualOperation(){this.make=function(a,b){return["eq",a,b]},this.execute=function(a,b){return b.operations[a[1][0]].execute(a[1],b)==b.operations[a[2][0]].execute(a[2],b)}}function GetOperation(){this.make=function(a){return["get",a]},this.execute=function(a,b){return b.record[a[1]]}}function InOperation(){this.make=function(a,b){return["in",a,b]},this.execute=function(a,b){for(var c=b.operations[a[1][0]].execute(a[1],b),d=b.operations[a[2][0]].execute(a[2],b),e=0;e<d.length;e++)if(c===d[e])return!0;return!1}}function JoinOperation(){this.make=function(a,b,c,d){return["join",a,b,c,d]},this.execute=function(a,b){for(var c=b.operations[a[1][0]].execute(a[1],b),d=b.operations[a[2][0]].execute(a[2],b),e=[],f=0;f<c.length;f++){var g=Object.create(c[f]);g[a[4]]=[];for(var h=0;h<d.length;h++)b.record={left:c[f],right:d[h]},b.operations[a[3][0]].execute(a[3],b)&&results.push(d[h]);g[a[4]]=results,e.push(g)}return e}}function NotOperation(){this.make=function(a){return["not",a]},this.execute=function(a,b){return!b.operations[a[1][0]].execute(a[1],b)}}function OrOperation(){this.make=function(a){return["or",a]},this.execute=function(a,b){for(var c=0;c<a[1].length;c++)if(b.operations[a[1][c][0]].execute(a[1][c],b))return!0;return!1}}function ParameterOperation(){this.make=function(a){return["param",a]},this.execute=function(a,b){return b.parameters[a[1]]}}function PathOperation(){this.make=function(a){return["path",a]},this.execute=function(a,b){for(var c=a[1].split("."),d=b.record,e=0;e<c.length;e++)d=d[c[e]];return d}}function SelectOperation(){this.make=function(a,b){return["select",a,b]},this.execute=function(a,b){var c=b.operations[a[1][0]].execute(a[1],b).filter(function(c){return b.record=c,b.operations[a[2][0]].execute(a[2],b)});return b.record=null,c}}function TableOperation(){this.make=function(a){return["table",a]},this.execute=function(a,b){return b.file.tables.values[a[1]]}}function TrueOperation(){this.make=function(){return["true"]},this.execute=function(){return!0}}function QueryBuilder(a){this.select=function(b,c){return a.operations.select.make(b,c)},this.table=function(b){return a.operations.table.make(b)},this.get=function(b){return a.operations.get.make(b)},this.const=function(b){return a.operations.const.make(b)},this.eq=function(b,c){return a.operations.eq.make(b,c)},this.true=function(){return a.operations.true.make()},this.execute=function(b){return a.operations[b[0]].execute(b,a)}}function Table(){this.createTable=function(a,b){a.tables.keys.push(b),a.tables.values[b]=[]},this.insert=function(a,b,c){a.tables.values[b].push(c)}}Jsonbase.Load=function(a){var b=new EnvironmentFactory,c=b.fromJson()(localStorage.getItem(a)||"null"),d=b.make(c);return new Jsonbase(d)};